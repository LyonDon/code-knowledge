事务

>事务就是一组原子性的查询语句，或者说一个独立的工作单元，事务内的语句，要么全部执行，要么都不执行

事务的ACID特性：

*	atomicity原子性
>一个事务必须被视为一个不可分割的最小工作单元

*	consistency一致性
>前后的数据完整性要保持一致

*	isolation隔离性
>多个用户并发访问时，一个事务不能被其他用户的事务干扰

*	durability持久性
>一个事务一旦被提交，其对数据库的改变时永久的

InnoDB应对死锁的办法是，将持有最少行级排他锁的事务进行回滚

对于非事务型的表，不存在自动提交的概念，相当于一直是自动提交

MVCC：多版本并发控制

## MySQL四种事务隔离级别

隔离级别|脏读|不可重复读|幻读
--|--|--|--
未提交读（Read Uncommitted）|可能|可能|可能
已提交读（Read Committed）|不可能|可能|可能
可重复读（Repeatable read）|不可能|不可能|可能
可串行化（Serializable）|不可能|不可能|不可能

*	未提交读：允许脏读，可能读取到其他事务中未提交事务修改的属性

*	已提交读：只能读取已经提交的数据。Oracle等

*	可重复读：在同一个事务内的查询都是事务开始时刻一致的。InnoDB默认

*	串行读：完全串行化的读，每次读都需要获取表级共享锁，读写互相会阻塞

脏读：读取到未提交的数据
幻读：读取到之前没有的数据
不可重复读：两次读取的数据不一致

### InnoDB和MyISAM

是MySQL的默认事务型引擎，也是最重要，最广泛的存储引擎。用来处理大量的短期事务

MyISAM是5.1版本之前默认的存储引擎，不支持事务和行级锁

|InnoDB|MyISAM
--|--|--
事务|支持|不支持（事务操作很重要，一些增删改查可以回滚操作）
外键|支持|不支持（且包含外键的InnoDB表不能转为MyISAM）
索引方式|聚集索引|非聚集索引
表的行数|不保存（获取行数时需要一行一行扫描）|保存
全文索引|不支持|支持（查询效率更高）
清空表|一行一行删|重建表


## 服务器性能剖析

**性能：完成某件任务所需要的时间度量，即响应时间**

有时候，cpu利用率的上升不一定是坏事，这说明对于资源的利用率变高了。区别在于，cpu利用率的上升是否影响到了系统的响应速度

### 性能优化

*	性能剖析：

	*	测量任务所花费的时间

	*	对结果进行统计和排序，将重要的任务排在前面

	*	基于任务执行时间的分析

	*	基于等待时间的分析

*任何可被执行的任务都可以进行性能剖析，不仅服务器，应用程序同样可以*

在编写sql语句时，可以加上性能剖析的代码。虽然这一部分会增加系统开销，但与其带来的好处相比，是瑕不掩瑜的

### 剖析MySQL查询

*	慢查询日志

>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中
>
>long_query_time的默认值为10，意思是运行10S以上的语句
>
>默认情况下，Mysql数据库并不启动慢查询日志，需要我们手动来设置这个参数，不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响(主要是日志对于磁盘空间的影响)
>
>慢查询日志支持将日志记录写入文件，也支持将日志记录写入数据库表


*	剖析单条查询

	*	show status
	*	show profile
	*	检查慢查询日志的条目

*	使用性能剖析

    *	慢查询日志

*	诊断间歇性问题

	*	单条查询问题还是服务器问题（前两种方法的开销比较低）

		*	使用show golbal status
		*	使用show processlist
		*	使用查询日志
			*	需开启慢查询日志在全局级别设置long_query_time为0，并确认所有连接都使用了新的配置

	*	捕获诊断数据

		*	诊断触发器
			*	诊断阈值的设置，要符合实际情况，确保不是短暂出现或者误报

	*	需要收集什么样的数据
		
        *	简单的说就是所有数据都收集，但是在需要的时间收集对应的数据

***
**一些性能剖析工具：**

工具名|用途
:--:|:--:
pt-query-digest|分析mysql查询日志的最有力工具
new relic|对应用程序进行性能剖析
user_statistics表|对数据库活动进行测量和审计,并且可以强制执行一些策略
strace|调查系统调用的情况
oprofile|查看cpu具体消耗情况
pt-summary、pt-mysql-summery|获取服务器状态、参数配置，软硬件环境

***

## MySQL索引

索引可以包含一个或者两个列

### 索引的类型

*	B树索引
	树的节点存储元素内容

*	哈希索引
	>对于每个数据计算一个hash码，将hash码存储在索引中

*	空间数据索引（R-Tree）

*	全文索引

>聚簇索引并不是一种索引类型，而是一种数据存储方式。具体的类型要看其内部实现方式


#### 索引的优点

1.	大大减少服务器需要扫描的数据量
2.	帮助服务器避免排序和临时表
3.	可以将随机IO变为顺序IO，顺序IO的数据块都在一起，可以降低扫描的时间

#### 高性能索引

*	独立的列，索引列应该是独立的，不能是表达式的一部分，或者是函数的参数
*	前缀索引，有时候列的内容太长，这时候就可以取前面的几个字符进行索引
*	……

#### 聚簇索引优点：

*	可以把相关数据保存在一起
*	访问数据更快
*	查询可以直接使用叶节点的主键值

#### 聚簇索引缺点：

*	对于内存中数据优化效果较差
*	插入速度依赖插入顺序
*	更新代价高

## MySQL数据类型

*	数值类型
	A|B
	--|--
	tinyint|1字节（-128~128）
	smallint|2字节
	*	mediumint|3字节
	*	int|4字节
	*	bigint|8字节
	*	float|4字节
	*	double|8字节
	*	decimal|依赖于decimal（A,B）的值

*	日期类型
	A|B
    --|--|--
    DATE|日期类型|YYYY-MM—DD
    TIME|时间值或者持续时间|HH：MM：SS
    YEAR|年份值|YYYY
    DATETIME|混合日期和时间值|YYYY-MM—DD HH：MM：SS
    TIMESTAMP|混合日期和时间值|YYYY-MM—DD HH：MM：SS

*	字符串类型

	A|B
    --|--
    CHAR|定长字符串
    VARCHAR|变长字符串
    TINYBLOB|短文本二进制字符串（255字节）
    TINYTEXT|短文本字符串
    BLOB|二进制长文本（65K）
    TEXT|长文本
    MEDIUMBOLB|中等长度二进制长文本（16M）
    MEDIUMTEXT|中等长度文本
    LONGBOLB|极大长度二进制文本（4G）
    LONGTEXT|极大长度文本

## MySQL主从复制与读写分离

>在实际的开发过程中，所有的数据库读写操作都发生在一个服务器上是不现实的。
>所以，需要设置主服务器和从服务器，使用复制的方式同步数据。在通过读写分离的方式提高服务器并发负载能力

### 主从复制

![主从复制.png](.\主从复制.png)

*	基于语句（MySQL默认）

	*	主服务器执行一条sql语句，从服务器执行一样的sql语句

*	基于行
	*	将行改变的内容复制到另一个服务器

*	混合
	*	语句不行的话，用行

### 读写分离

![读写分离.jpg](.\读写分离.jpg)

>在主服务器上修改数据，在从服务器上同步。从服务器只能读取，不支持写入。这样在实现数据数据备份的情况下，优化了数据库性能，提高了系统的安全性

*	基于程序代码实现
	使用select，insert等设置路由分类
	*	高效，性能更好，不需要额外的开销
	*	开发人员手动写，不好运维

*	基于代理服务器实现
	使用搭理服务器转发应用服务器的修改到后端服务器上

## 关系型数据库&非关系型数据库

*	关系型数据库：以表的方式存储数据，Oracle，MySQL等，慢，安全
*	非关系型数据库：以其他（列，键值对）方式存储数据，redis，MangoDB等，效率高，不够安全（断电丢失等。但是redis支持磁盘写入）
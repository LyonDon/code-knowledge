事务

>事务就是一组原子性的查询语句，或者说一个独立的工作单元，事务内的语句，要么全部执行，要么都不执行

事务的ACID特性：

*	atomicity原子性
>一个事务必须被视为一个不可分割的最小工作单元

*	consistency一致性
>前后的数据完整性要保持一致

*	isolation隔离性
>多个用户并发访问时，一个事务不能被其他用户的事务干扰

*	durability持久性
>一个事务一旦被提交，其对数据库的改变时永久的

InnoDB应对死锁的办法是，将持有最少行级排他锁的事务进行回滚

对于非事务型的表，不存在自动提交的概念，相当于一直是自动提交

MVCC：多版本并发控制


### InnoDB和MyISAM

是MySQL的默认事务型引擎，也是最重要，最广泛的存储引擎。用来处理大量的短期事务

MyISAM是5.1版本之前默认的存储引擎，不支持事务和行级锁

|InnoDB|MyISAM
--|--|--
事务|支持|不支持
外键|支持|不支持（且包含外键的InnoDB表不能转为MyISAM）
索引方式|聚集索引|非聚集索引
表的行数|不保存|保存
全文索引|不支持|支持（查询效率更高）

### 转换表的引擎

*	alter table
*	导入与导出
*	创建于查询（create 和 select）

## MySQL四种事务隔离级别

隔离级别|脏读|不可重复读|幻读
--|--|--|--
未提交读（Read Uncommitted）|可能|可能|可能
已提交读（Read Committed）|不可能|可能|可能
可重复读（Repeatable read）|不可能|不可能|可能
可串行化（Serializable）|不可能|不可能|不可能

*	未提交读：允许脏读，可能读取到其他事务中未提交事务修改的属性

*	已提交读：只能读取已经提交的数据。Oracle等

*	可重复读：在同一个事务内的查询都是事务开始时刻一致的。InnoDB默认

*	串行读：完全串行化的读，每次读都需要获取表级共享锁，读写互相会阻塞

## MySQL基准测试

针对系统状态的一种压力测试，用于掌握系统的行为

*区别于真实压力测试，基准测试的强度更低，不想真实情况下的数据量那么大，变化多端*

*	系统测试
*	组件测试

测试指标：

*	吞吐量
*	响应时间或者延迟
*	并发性
*	可扩展性

*基准测试应运行足够长的时间*

*每一次测试中，修改的参数应该尽可能的少*

测试类型：

*	集成式测试
	*	集成式测试工具

		*	ab
		*	http_load
		*	JMeter

*	单组件式测试
	*	单组件式测试工具

		*	sysbench（一款多线程系统压测工具）等

_ _ _

### BenchMark函数

用来测试某条指令的执行速度
_ _ _

### sysbench

sysbench是一个模块化，跨平台。多线程的基准测试工具。可以执行多种类型的基准测试，它不仅设计用来测试数据库的性能，也可以测试运行数据库的服务器的性能

主要包括以下几种方式的测试：

*	CPU性能
*	file I/O性能
*	程序调度性能
*	线程性能
*	数据库性能（OLPT测试）

#### sysbench的CPU基准测试
~~~
sysbench --test=cpu （参数）
~~~

#### sysbench的文件I/O基准测试
~~~
sysbench --test=fileio
~~~

*测试完成后，运行清除操作删除第一步生成的测试文件*
~~~
sysbench --test=fileio （参数） cleanup
~~~

### sysbench的OLTP基准测试

**模拟一个简单的事务处理系统的工作负载**

_ _ _

### dbt2 TPC-C测试

>TPC-C benchmark是Transaction Processing Council制定测试数据库benchmark标准，它是基于批发供应商（也称之为company）的模型
>
>TPC-C被广泛用于CS环境下，用于测试客户端服务器组成系统的整体性能
>
>TPC-C的值可以反映整个系统的性价比，TPCC测试系统每分钟处理的任务数,单位为tpm,(transactions per minute)。系统的总体价格(单位为美元)除以TPCC值,就可以衡量出系统的性价比,系统的性价比值越小,系统的性价比越好

****

## 服务器性能剖析

**性能：完成某件任务所需要的时间度量，即响应时间**

有时候，cpu利用率的上升不一定是坏事，这说明对于资源的利用率变高了。区别在于，cpu利用率的上升是否影响到了系统的响应速度

### 性能优化

*	性能剖析：

	*	测量任务所花费的时间

	*	对结果进行统计和排序，将重要的任务排在前面

	*	基于任务执行时间的分析

	*	基于等待时间的分析

*任何可被执行的任务都可以进行性能剖析，不仅服务器，应用程序同样可以*

在编写sql语句时，可以加上性能剖析的代码。虽然这一部分会增加系统开销，但与其带来的好处相比，是瑕不掩瑜的

### 剖析MySQL查询

*	慢查询日志

>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中
>
>long_query_time的默认值为10，意思是运行10S以上的语句
>
>默认情况下，Mysql数据库并不启动慢查询日志，需要我们手动来设置这个参数，不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响(主要是日志对于磁盘空间的影响)
>
>慢查询日志支持将日志记录写入文件，也支持将日志记录写入数据库表


*	剖析单条查询

	*	show status
	*	show profile
	*	检查慢查询日志的条目

*	使用性能剖析

    *	慢查询日志

*	诊断间歇性问题

	*	单条查询问题还是服务器问题（前两种方法的开销比较低）

		*	使用show golbal status
		*	使用show processlist
		*	使用查询日志
			*	需开启慢查询日志在全局级别设置long_query_time为0，并确认所有连接都使用了新的配置

	*	捕获诊断数据

		*	诊断触发器
			*	诊断阈值的设置，要符合实际情况，确保不是短暂出现或者误报

	*	需要收集什么样的数据
		
        *	简单的说就是所有数据都收集，但是在需要的时间收集对应的数据

***
**一些性能剖析工具：**

工具名|用途
:--:|:--:
pt-query-digest|分析mysql查询日志的最有力工具
new relic|对应用程序进行性能剖析
user_statistics表|对数据库活动进行测量和审计,并且可以强制执行一些策略
strace|调查系统调用的情况
oprofile|查看cpu具体消耗情况
pt-summary、pt-mysql-summery|获取服务器状态、参数配置，软硬件环境

***